<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Edit Bills - Debug Version</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="dashboard">
    <aside class="sidebar">
      <h2 class="company-title">ABC Company</h2>
      <ul class="menu">
        <li><a href="make_bill.html">Make a New Bill</a></li>
        <li id="edit_bill_link" class="active"><a href="edit_bill.html">Edit a Bill</a></li>
        <li><a href="#">Report</a></li>
        <li><a href="deleted_bills.html">Deleted Bills</a></li>
        <li><a href="#">Add Purchase</a></li>
      </ul>
    </aside>

    <main class="content">
      <header>
        <h1>Saved Bills</h1>
        <button id="logoutBtn">Logout</button>
      </header>
      <section class="info">
        <p>Here is a list of your saved bills. Click on one to view or edit it.</p>
        <div id="billListContainer">
          <ul id="billList">
            <li>Loading bills...</li>
          </ul>
        </div>
      </section>
    </main>
  </div>

<script>
    const BASE_URL = "https://billing-backend-j0ui.onrender.com";
    
    // Wait for DOM to be fully loaded
    document.addEventListener("DOMContentLoaded", function() {
        console.log("üöÄ DOM Loaded - Edit Bills Page");
        
        // Add logout functionality
        const logoutBtn = document.getElementById("logoutBtn");
        if (logoutBtn) {
            logoutBtn.addEventListener("click", async () => {
                try {
                    await fetch(`${BASE_URL}/api/logout`, {
                        method: 'POST',
                        credentials: 'include'
                    });
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error('Logout error:', error);
                    window.location.href = 'index.html';
                }
            });
        }
        
        // Initialize edit bills functionality
        initializeEditBills();
    });

    function initializeEditBills() {
        console.log("üîß Initializing Edit Bills");
        
        const billList = document.getElementById("billList");
        if (!billList) {
            console.error("‚ùå billList element not found!");
            return;
        }
        
        // Load bills from server
        loadBills();
    }

    function loadBills() {
        console.log("üì° Loading bills...");
        
        const billList = document.getElementById("billList");
        billList.innerHTML = "<li>Loading bills...</li>";
        
        fetch(`${BASE_URL}/api/get-bills`, {
            method: "GET",
            credentials: "include"
        })
        .then(response => {
            console.log("üì• Response:", response.status);
            
            if (!response.ok) {
                if (response.status === 401) {
                    billList.innerHTML = "<li style='color: red;'>Please log in first. <a href='index.html'>Login</a></li>";
                    throw new Error('Not authenticated');
                }
                throw new Error(`HTTP ${response.status}`);
            }
            
            return response.json();
        })
        .then(billRecords => {
            console.log("üìä Bills received:", billRecords?.length, "bills");
            
            if (!Array.isArray(billRecords) || billRecords.length === 0) {
                billList.innerHTML = "<li style='color: blue;'>No bills found. <a href='make_bill.html'>Create one</a></li>";
                return;
            }
            
            displayBills(billRecords);
        })
        .catch(error => {
            console.error("üí• Error:", error);
            billList.innerHTML = `<li style='color: red;'>Error: ${error.message} <button onclick="loadBills()">Retry</button></li>`;
        });
    }

    function displayBills(billRecords) {
        const billList = document.getElementById("billList");
        billList.innerHTML = "";
        
        billRecords.forEach(record => {
            let bill;
            
            // Parse billData from your server
            try {
                bill = JSON.parse(record.billData);
            } catch (e) {
                // Fallback: construct from database fields
                bill = {
                    estimateNo: record.estimate_no || 'Unknown',
                    customerName: record.customer_name || 'Unknown',
                    customerPhone: record.customer_phone || '',
                    billDate: record.bill_date || '',
                    grandTotal: record.grand_total || 0,
                    items: []
                };
            }
            
            const li = document.createElement("li");
            li.className = "bill-item";
            li.innerHTML = `
                <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0;">
                    <strong>Bill #<span class="bill-no">${bill.estimateNo}</span></strong><br>
                    Customer: ${bill.customerName}<br>
                    Date: ${bill.billDate}<br>
                    Total: ‚Çπ${bill.grandTotal}
                    <div style="margin-top: 10px;">
                        <button class="edit-btn" style="background: #28a745; color: white; padding: 5px 10px; margin-right: 5px; border: none;">Edit</button>
                        <button class="delete-btn" style="background: #dc3545; color: white; padding: 5px 10px; border: none;">Delete</button>
                    </div>
                </div>
            `;
            li.dataset.bill = JSON.stringify(bill);
            billList.appendChild(li);
        });
        
        setupBillActions();
    }

    function setupBillActions() {
        const billList = document.getElementById("billList");
        
        billList.addEventListener("click", async (e) => {
            const billItem = e.target.closest(".bill-item");
            if (!billItem) return;
            
            if (e.target.classList.contains("edit-btn")) {
                const billData = JSON.parse(billItem.dataset.bill);
                localStorage.setItem("billToEdit", JSON.stringify(billData));
                window.location.href = "make_bill.html";
                
            } else if (e.target.classList.contains("delete-btn")) {
                const billData = JSON.parse(billItem.dataset.bill);
                
                if (confirm(`Delete bill #${billData.estimateNo}?`)) {
                    try {
                        const response = await fetch(`${BASE_URL}/api/delete-bill`, {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({ estimateNo: billData.estimateNo })
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok && result.success) {
                            billItem.remove();
                            alert('Bill deleted successfully');
                            
                            if (billList.children.length === 0) {
                                billList.innerHTML = "<li>No bills found.</li>";
                            }
                        } else {
                            alert('Failed to delete: ' + (result.message || 'Unknown error'));
                        }
                    } catch (error) {
                        alert('Delete error: ' + error.message);
                    }
                }
            }
        });
    }

    // Make loadBills global for retry button
    window.loadBills = loadBills;
  </script>
</body>
</html>